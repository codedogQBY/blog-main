# 📱 前端博客缓存策略配置

## 🎯 缓存策略概览

本博客前端采用**网络优先**的缓存策略，确保用户始终能获取到最新的内容数据。

### 🔄 策略原则

1. **所有博客数据** = 网络优先 ➜ 缓存后备
2. **图片资源** = 缓存优先 ➜ 网络后备  
3. **静态资源** = 缓存优先 ➜ 网络后备

## 📊 详细策略配置

### 🥇 优先级1：博客数据（网络优先）

- **API请求** (`/api/*`)
- **文章内容** (`/blog/*`, `/diary/*`)
- **评论互动** (`/interactions/*`, `/sticky-notes`)
- **搜索功能** (`/search`)
- **系统配置** (`/system-config`)
- **Next.js数据** (`/_next/data/*`)

**策略**：
```
尝试网络获取 → 成功则返回并缓存 → 失败则使用缓存 → 缓存也失败则显示错误
```

### 🥈 优先级2：页面导航（网络优先）

- **HTML页面**
- **路由导航**

**策略**：
```
尝试网络获取 → 成功则返回并缓存 → 失败则使用缓存 → 缓存也失败则显示离线页面
```

### 🥉 优先级3：图片资源（缓存优先）

- **所有图片格式** (jpg, png, gif, webp, svg, ico)

**策略**：
```
检查缓存 → 有缓存则直接返回 → 无缓存则网络获取并缓存
```

### 🔧 优先级4：静态资源（缓存优先）

- **CSS文件** (*.css)
- **JavaScript文件** (*.js)
- **字体文件** (*.woff, *.woff2, *.ttf, *.eot)

**策略**：
```
检查缓存 → 有缓存则直接返回 → 无缓存则网络获取并缓存
```

## ⚙️ 配置参数

### 🕐 缓存时间

| 资源类型 | 缓存时间 | 说明 |
|---------|---------|------|
| API数据 | 5分钟 | 确保内容及时更新 |
| 图片资源 | 24小时 | 平衡流量和体验 |
| 静态资源 | 30天 | 最大化性能优化 |
| 页面内容 | 1小时 | 保证页面更新 |

### ⏱️ 网络超时

| 请求类型 | 超时时间 | 说明 |
|---------|---------|------|
| API请求 | 8秒 | 充足的响应时间 |
| 页面请求 | 5秒 | 快速页面加载 |
| 图片请求 | 10秒 | 允许大图片加载 |

### 💾 存储限制

| 缓存类型 | 最大条目 | 最大大小 |
|---------|---------|---------|
| API缓存 | 100条 | 10MB |
| 图片缓存 | 200张 | 50MB |
| 静态资源 | 50个 | 20MB |
| 页面缓存 | 30个 | 5MB |

## 🛠️ 自定义配置

### 修改API域名

编辑 `src/lib/sw-config.ts` 文件：

```typescript
API_DOMAINS: [
  'localhost:3001',
  'your-api-domain.com', // 替换为你的实际API域名
  'api.yourblog.com',   // 添加更多域名
]
```

### 调整缓存策略

如果你希望某些资源使用不同的策略，修改 `RESOURCE_STRATEGIES`：

```typescript
RESOURCE_STRATEGIES: {
  API_DATA: 'network-first',     // 网络优先
  PAGES: 'network-first',        // 网络优先  
  IMAGES: 'cache-first',         // 缓存优先
  STATIC_ASSETS: 'cache-first',  // 缓存优先
}
```

### 启用调试模式

开发期间可以启用详细日志：

```typescript
DEBUG: {
  VERBOSE_LOGGING: true,    // 详细日志
  LOG_CACHE_HITS: true,     // 缓存命中日志
  LOG_PERFORMANCE: true,    // 性能日志
}
```

## 🔍 监控和调试

### 查看缓存状态

1. 打开浏览器开发者工具
2. 切换到 `Application` 标签
3. 查看 `Storage > Cache Storage`
4. 检查各个缓存的内容

### 查看Service Worker日志

1. 打开浏览器开发者工具
2. 切换到 `Console` 标签  
3. 查看缓存命中/未命中的日志

### 强制刷新缓存

在开发者工具中：
1. 右键刷新按钮
2. 选择 "清空缓存并硬性重新加载"

## 📱 离线体验

### 离线可用功能

- ✅ 已缓存的文章内容
- ✅ 已缓存的图片
- ✅ 基本页面导航
- ✅ 静态资源(CSS/JS)

### 离线不可用功能  

- ❌ 新文章获取
- ❌ 评论提交
- ❌ 搜索功能
- ❌ 实时数据更新

## 🚀 性能优化建议

### 1. 预缓存关键资源

在 `public/sw.js` 的 `STATIC_ASSETS` 中添加关键页面：

```javascript
const STATIC_ASSETS = [
  '/',
  '/blog',
  '/diary',
  '/offline',
  // 添加更多关键页面
]
```

### 2. 图片优化

- 使用 WebP 格式
- 设置合适的图片尺寸
- 启用图片懒加载

### 3. 减少API调用

- 合并相关API请求
- 使用分页减少单次数据量
- 实现客户端缓存

## 🔧 故障排除

### 缓存不更新

1. 检查缓存版本号是否更新
2. 清空浏览器缓存
3. 检查网络连接

### Service Worker无法注册

1. 确保使用HTTPS或localhost
2. 检查文件路径是否正确
3. 查看控制台错误信息

### API请求总是失败

1. 检查API域名配置
2. 验证网络连接
3. 查看网络请求日志

---

💡 **提示**：修改缓存策略后，记得更新缓存版本号 (`CACHE_VERSION`)，这样会自动清空旧缓存并应用新策略。 